angular.module("kMeansModule",["pascalprecht.translate","ngSanitize","localeHelperModule"]).config(["$translateProvider","localeHelperProvider",function(e,t){e.useLoader("translationLoader"),console.log("localeHelperProvider",t);var n=t.getLocale(window.location.pathname);console.log("locale = ",n),e.preferredLanguage(n),e.useSanitizeValueStrategy("escapeParameters")}]).factory("translationLoader",["$http","$q","$rootScope",function(e,t,n){return function(r){var a=t.defer(),o={};return o[r.key]?(a.resolve(o[r.key]),a.promise):(e({method:"GET",url:"/locales/"+r.key+".json"}).then(function(e){a.resolve(e),console.log("localeResource:load"),n.$emit("localeResource:load")},a.reject),a.promise)}}]).controller("kMeansCtrl",["$scope","$timeout","$filter","$q",function(e,t,n,r){function a(t){e.computing=!0;var a=r.defer(),o=n("translate")("原始数据");return C=$("#mycanvas").plot([{data:t,label:o}],S),R=C.data("plot"),window.plot=R,a.resolve(),e.computing=!1,a.promise}function o(e){e.forEach(function(e){delete e.color}),R.setData(e),R.setupGrid(),R.draw()}function c(e){var t=R.getData();o(t.concat(e))}function u(e){var t=R.getData();t.splice(-e.length),o(t.concat(e))}function l(e){for(var t,n=e.slice(0),r=[],a=n.length;a;)t=Math.floor(Math.random()*a--),r.push(n.splice(t,1)[0]);return r}function i(t){for(var n=[],r=l(e.testData),a=0;a<t;a++)n.push(r[a]);return n}function s(e){var t=i(e);return c(g(t)),t}function f(e,t){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)}function p(e){return e.map(function(){return[]})}function d(e,t){for(var n=p(t),r=0;r<e.length;r++){for(var a=e[r],o=1/0,c=-1,u=0;u<t.length;u++){var l=f(a,t[u]);l<o&&(o=l,c=u)}n[c]instanceof Array||(n[c]=[]),n[c].push(a)}return n}function g(e){return{data:e,label:n("translate")("质心"),points:{symbol:"cross"}}}function v(e){var t=[];return e.forEach(function(e,r){t.push({data:e,label:n("translate")("类")+" "+r})}),t}function m(t){var n=e.testData;return d(n,t)}function h(e){return e.reduce(function(e,t){return Number(e)+Number(t)},0)/e.length}function w(e,t){return e.map(function(e){return e[t]})}function D(e){return[h(w(e,0)),h(w(e,1))]}function M(e){return e.map(function(e){return D(e)})}function y(){a(e.testData);var t=s(e.kMeansData.k),n=m(t);return c(v(n)),{centers:t,clusters:n}}function b(e){var t=M(e);return e=m(t),u([g(t)].concat(v(e))),{centers:t,clusters:e}}function k(e,t){return!!e&&!!t&&!(e<t||t<e)}function x(t,n){e.current=angular.extend({},t),e.current.iteration=n}function L(n,r,a,o){for(var c=function(){return n<=e.kMeansData.maxLoops};c();){n++;var u=b(r);if(x(u,n),(!c()||k(a,u.centers))&&"function"==typeof o)return o(u);t(function(){L(n,u.clusters,u.centers,o)},e.interval);break}}function H(t){console.log("done"),console.log(t),e.computing=!1,e.clusteringResult=t}e.testData=[[2,1],[1,2],[2,2],[3,2],[2,3],[3,3],[2,4],[3,5],[4,4],[5,3]];var C,R,S={series:{lines:{show:!1},points:{show:!0}},zoom:{interactive:!1},pan:{interactive:!0},legend:{show:!0},grid:{hoverable:!0,clickable:!0},xaxis:{autoscaleMargin:.5},yaxis:{autoscaleMargin:.5},colors:["red","orange","yellow","green","cyan","blue","purple"]};e.kMeansData={k:2,maxLoops:10},e.computing=!0,t(function(){a(e.testData)}),e.interval=100,e.computing=!1,e.kMeans=function(){e.computing=!0;var n=y();t(function(){var e=0;L(e,n.clusters,n.centers,H)},e.interval)};var E=document.getElementById("data-table");new Handsontable(E,{data:e.testData,colHeaders:["x","y"],maxCols:2,rowHeaders:!0,contextMenu:!0,autoWrapRow:!0,Controller:!0,minSpareRows:1,beforeChange:function(e,t){},afterChange:function(){e.testData=this.getData().filter(function(e){return null!==e[0]&&null!==e[1]}),a(e.testData)}})}]);